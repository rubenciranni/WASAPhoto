openapi: '3.0.2'
info:
  title: WASAPhoto Backend API
  version: '1.0'
  description: |-
    The WASAPhoto Backend API allows to perform the following operations:
    - Log in by specifying a username.
    - Get the a stream of photos (images) in reverse chronological order for the logged in user,
      with information about when each photo was uploaded (date and time) and how many likes
      and comments it has. The stream is composed by photos from “following”
      (other users that the user follows).
    - Place (or  remove) a “like” to photos from other users.
    - Add comments to any image (even those uploaded by themself), and remove
      them (only authors can remove their comments).
    - Ban other users and remove the ban.
    - Get users profiles showsing: the user’s photos (in reverse chronological order),
      how many photos have been uploaded, and the user’s followers and following.
    - Change username
    - Upload photos and remove photos (removal of an image will also remove likes and comments).
    - Follow/unfollow other users.
    - Search other user profiles via username.

security:
  - bearerAuth: []

tags:
  - name: login
  - name: settings
  - name: photos
  - name: likes
  - name: comments
  - name: users
  - name: profile
  - name: following
  - name: bans
  - name: stream

paths:
  /session:
    post:
      tags: ["login"]
      summary: Logs in the user 
      description: |-
        If the user does not exist, it will be created,
        and an identifier is returned.
        If the user exists, the user identifier is returned.
      operationId: doLogin
      requestBody: { $ref: "#/components/requestBodies/DoLogin" }
      security: []
      responses:
        '201': { $ref: "#/components/responses/SuccessfulDoLogin" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /settings/username:
    put:
      tags: ["settings"]
      summary: Updates the username
      description: |-
        It updates the username of the logged in user with the new
        username provided in request body; it returns `Forbidden Error` if the new
        username is already taken by another user.
      operationId: setMyUserName
      requestBody: { $ref: "#/components/requestBodies/SetMyUserName" }
      responses:
        '201': { $ref: "#/components/responses/SuccessfulSetMyUserName" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /photos/:
    post:
      tags: ["photos"]
      summary: Uploads a new photo
      description: |-
        Uploads a new photo authored by the logged in user.
      operationId: uploadPhoto
      requestBody: { $ref: "#/components/requestBodies/UploadPhoto" }
      responses:
        '201': { $ref: "#/components/responses/SuccessfulUploadPhoto" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '413': { $ref: "#/components/responses/ContentTooLarge" }
        '415': { $ref: "#/components/responses/UnsupportedMediaType" }
        '500': { $ref: "#/components/responses/InternalServerError" }
    get:
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
        - $ref: "#/components/parameters/QueryStringUserId"
      tags: ["photos"]
      summary: Gets a list of photos.
      description: |-
        If the logged in user is not banned by the user with `userId` specified
        in query string, it returns a list of photos authored by that user;
        otherwise it returns an error.
      operationId: getPhotos
      responses:
        '200': { $ref: "#/components/responses/SuccessfulGetPhotos" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /photos/{photoId}:
    parameters:
      - $ref: "#/components/parameters/PathPhotoId"
    get:
      tags: ["photos"]
      summary: Gets a photo
      description: |-
        If the logged in user is not banned by the author of the photo,
        it returns the requested photo; otherwise it returns an error.
      operationId: getPhoto
      responses:
        '200': { $ref: "#/components/responses/SuccessfulGetPhoto" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
    delete:
      tags: ["photos"]
      summary: Deletes a photo
      description: |-
        If the logged in user is the author of the photo
        with `photoId` given in path, it deletes the photo;
        otherwise, it returns an error.
      operationId: deletePhoto
      responses:
        '200': { $ref: "#/components/responses/SuccessfulDeletePhoto" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /photos/{photoId}/likes/:
    parameters:
      - $ref: "#/components/parameters/PathPhotoId"
    get:
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
      tags: ["likes"]
      summary: Gets the likes for a photo
      description: |-
        If the logged in user is not banned by the author of the photo, it returns
        the list of users who liked the photo; otherwise it returns an error.
      operationId: getLikes
      responses:
        '200': { $ref: "#/components/responses/SuccessfulGetLikes" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /photos/{photoId}/comments/:
    parameters:
      - $ref: "#/components/parameters/PathPhotoId"
    get:
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
      tags: ["comments"]
      summary: Gets the comments for a photo
      description: |-
        If the logged in user is not banned by the author of the photo, it returns
        the list of comments of the photo; otherwise it returns an error.
      operationId: getComments
      responses:
        '200': { $ref: "#/components/responses/SuccessfulGetComments" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
    post:
      tags: ["comments"]
      summary: Adds a comment to a photo.
      description: |-
        If the logged in user is not banned by the author of the photo, it adds
        a comment to the photo authored by the logged in user;
        otherwise it returns an error.
      operationId: commentPhoto
      requestBody: { $ref: "#/components/requestBodies/CommentPhoto" }
      responses:
        '201': { $ref: "#/components/responses/SuccessfulCommentPhoto" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '413': { $ref: "#/components/responses/ContentTooLarge" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /photos/{photoId}/comments/{commentId}:
    parameters:
      - $ref: "#/components/parameters/PathPhotoId"
      - $ref: "#/components/parameters/PathCommentId"
    delete:
      tags: ["comments"]
      summary: Removes a comment from a photo
      description: |-
        If the logged in user is the author of the comment, it deletes it;
        otherwise it returns an error.
      operationId: uncommentPhoto
      responses:
        '200': { $ref: "#/components/responses/SuccessfulUncommentPhoto" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /users/:
    parameters:
      - $ref: "#/components/parameters/QueryStringUsername"
    get:
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
      tags: ["users"]
      summary: Gets users matching given username.
      description: |-
        Returns an array of users that match the `username` given in query.
      operationId: searchUser
      responses:
        '200': { $ref: "#/components/responses/SuccessfulSearchUser" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /users/{userId}:
    parameters:
      - $ref: "#/components/parameters/PathUserId"
    get:
      tags: ["profile"] 
      summary: Gets a user profile.  
      description: |-
        If the logged in user is not banned by the user with `userId` given in path,
        it returns its profile; otherwise it returns an error.
      operationId: getUserProfile
      responses:
        '200': { $ref: "#/components/responses/SuccessfulGetUserProfile" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /users/{userId}/following/:
    parameters:
      - $ref: "#/components/parameters/PathUserId"
    get:
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
      tags: ["users"]
      summary: Gets the following of a user
      description: |-
        If the logged in user is not banned by the user with `userId` given in path,
        it returns the list of its following; otherwise it returns an error.
      operationId: getFollowing
      responses:
        '200': { $ref: "#/components/responses/SuccessfulGetFollowing" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /users/{userId}/followers/:
    parameters:
      - $ref: "#/components/parameters/PathUserId"
    get:
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
      tags: ["users"]
      summary: Gets the followers of a user
      description: |-
        If the logged in user is not banned by the user with `userId` given in path,
        it returns the list of its followers; otherwise it returns an error.
      operationId: getFollowers
      responses:
        '200': { $ref: "#/components/responses/SuccessfulGetFollowers" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /liked-photos/{photoId}:
    parameters:
      - $ref: "#/components/parameters/PathPhotoId"
    put:
      tags: ["likes"]
      summary: Adds a like to a photo
      description: |-
        If the logged in user is not banned by the author of the the photo with
        `photoId` given in path, it adds a like to the photo;
        otherwise it returns an error.
      operationId: likePhoto
      responses:
        '201': { $ref: "#/components/responses/SuccessfulLikePhoto" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
    delete:
      tags: ["likes"]
      summary: Removes the like from a photo
      description: |-
        It removes the like from the photo with `photoId` given in path
        (or does nothing if the photo already does not have a like);
        otherwise it returns an error.
      operationId: unlikePhoto
      responses:
        '200': { $ref: "#/components/responses/SuccessfulUnlikePhoto" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /following/{userId}:
    parameters:
       - $ref: "#/components/parameters/PathUserId"
    put:
      tags: ["following"]
      summary: Adds a user to following
      description: |-
        If the logged in user is not banned by the user with `userId` given in path,
        it adds him/her to the following of the logged in user;
        otherwise it returns an error.
      operationId: followUser
      responses:
        '201': { $ref: "#/components/responses/SuccessfulFollowUser" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
    delete:
      tags: ["following"]
      summary: Removes a user from following
      description: |-
        It unfollows the user with `userId` given in path
        (or does nothing if it is alerady not followed);
        otherwise it returns an error.
      operationId: unfollowUser
      responses:
        '200': { $ref: "#/components/responses/SuccessfulUnfollowUser" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /bans/{userId}:
    parameters:
       - $ref: "#/components/parameters/PathUserId"
    put:
      tags: ["bans"]
      summary: Adds a user to bans
      description: |-
        It adds the user with `userId` given in path to the bans of the logged in user.
      operationId: banUser
      responses:
        '201': { $ref: "#/components/responses/SuccessfulBanUser" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
    delete:
      tags: ["bans"]
      summary: Removes a user from bans
      description: |-
        It removes the user with `userId` given in path from the bans of the logged in user.
      operationId: unbanUser
      responses:
        '200': { $ref: "#/components/responses/SuccessfulUnbanUser" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '403': { $ref: "#/components/responses/Forbidden" }
        '404': { $ref: "#/components/responses/NotFound" }
        '500': { $ref: "#/components/responses/InternalServerError" }
  /stream:
    get:
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
      tags: ["stream"]
      summary: Gets the stream of the logged in user
      description: |-
        Returns a list of photos from followed users in reverse chronological
        order.
      operationId: getMyStream
      responses:
        '200': { $ref: "#/components/responses/SuccessfulGetMyStream" }
        '401': { $ref: "#/components/responses/Unauthorized" }
        '500': { $ref: "#/components/responses/InternalServerError" }

components:
  schemas:
    # Fields
    errorMessage:
      description: An error message.
      type: string
      example: "Internal Server Error: Unexpected condition was encountered."
      pattern: '.*'
      minLength: 0
      maxLength: 269
    date-time:
      description: A date-time.
      type: string
      format: date-time
    text:
      description: A generic text.
      type: string
      minLength: 0
      maxLength: 2200
    photo:
      description: A png photo of 10 MB maximum size in binary format.
      type: string
      format: binary
      minLength: 536
      maxLength: 10485760 # 10MB
    username:
      description: Username associated with a unique user.
      type: string
      example: Maria
      pattern: 'ˆ.*?$' 
      minLength: 3
      maxLength: 16
    userId:
      description: UUID associated with a unique user.
      type: string
      format: uuid
    photoId:
      description: UUID associated with a unique photo.
      type: string
      format: uuid
    commentId:
      description: UUID associated with a unique comment.
      type: string
      format: uuid
    # Objects
    PaginatedList:
      description: A generic paginated list.
      type: object
      properties:
        previousOffset:
          type: integer
          minimum: 0
        nextOffset:
          type: integer
          minimum: 0
        hasPrevious:
          type: boolean
        hasNext:
          type: boolean
    User:
      description: An existing user.
      type: object
      properties:
        userId: { $ref: "#/components/schemas/userId" }
        username: { $ref: "#/components/schemas/username" }
    UserList:
      description: A list of users.
      allOf:
        - $ref: "#/components/schemas/PaginatedList"
        - type: object
          properties:
            records:
              type: array
              items: { $ref: "#/components/schemas/User" }
              minItems: 0
              maxItems: 50
    UserProfile:
      description: A user profile.
      type: object
      properties:
        userId: { $ref: "#/components/schemas/userId" }
        username: { $ref: "#/components/schemas/username" }
        numberOfPhotos:
          type: integer
        numberOfFollowers:
          type: integer
        numberOfFollowing:
          type: integer
    Photo:
      description: An existing photo.
      properties:
        author: { $ref: "#/components/schemas/User" }
        date-time: { $ref: "#/components/schemas/date-time" }
        caption: { $ref: "#/components/schemas/text" }
        numberOfLikes:
          type: integer
        numberOfComments:
          type: integer
        photoId: { $ref: "#/components/schemas/photoId" }
    PhotoList:
      description: A list of photos.
      allOf:
        - $ref: "#/components/schemas/PaginatedList"
        - type: object
          properties:
            records:
              type: array
              items: { $ref: "#/components/schemas/Photo" }
              minItems: 0
              maxItems: 50
    Comment:
      description: A comment.
      type: object
      properties:
        commentId: { $ref: "#/components/schemas/commentId" }
        comment: { $ref: "#/components/schemas/text" }
        author: { $ref: "#/components/schemas/User" }
        date-time: { $ref: "#/components/schemas/date-time" }
    CommentList:
      description: A list of comments.
      allOf:
        - $ref: "#/components/schemas/PaginatedList"
        - type: object
          properties:
            records:
              type: array
              items: { $ref: "#/components/schemas/Comment" }
              minItems: 0
              maxItems: 50
  requestBodies:
    DoLogin:
      description: User details.
      content:
        application/json:
          schema:
            type: object
            properties:
              username: { $ref: "#/components/schemas/username" }
      required: true
    SetMyUserName:
      description: New username.
      content:
        application/json:
          schema:
            type: object
            properties:
              newUsername: { $ref: "#/components/schemas/username" }
    UploadPhoto:
      description: Photo and caption.
      content:
        multipart/form-data:
          schema:
            type: object
            properties:
              photo: { $ref: "#/components/schemas/photo" }
              caption: { $ref: "#/components/schemas/text" }
      required: true
    CommentPhoto:
      description: Comment to add to the photo.
      content:
        application/json:
          schema:
            type: object
            properties:
              comment: { $ref: "#/components/schemas/text" }
  responses:
    InternalServerError:
      description: Unexpected condition was encountered.
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { $ref: "#/components/schemas/errorMessage" }
    Unauthorized:
      description: Authorization identifier is missing or invalid.
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { $ref: "#/components/schemas/errorMessage" }
    Forbidden:
      description: Logged in user cannot perform the requested operation.
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { $ref: "#/components/schemas/errorMessage" }
    NotFound:
      description: Requested resource was not found.
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { $ref: "#/components/schemas/errorMessage" }
    ContentTooLarge:
      description: Content provided in request is too large.
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { $ref: "#/components/schemas/errorMessage" }
    UnsupportedMediaType:
      description: Content media type provided in request is not supported
    SuccessfulDoLogin:
      description: User log-in action successful.
      content:
        application/json:
          schema:
            type: object
            properties:
              userId: { $ref: "#/components/schemas/userId" }
    SuccessfulSetMyUserName:
      description: Username updated successfully.
    SuccessfulUploadPhoto:
      description: Photo uploaded successfully.
      content:
        application/json:
          schema:
            type: object
            properties:
              photoId: { $ref: "#/components/schemas/photoId" }
    SuccessfulGetPhoto:
      description: The requested photo.
      content:
        image/png:
          schema: { $ref: "#/components/schemas/photo" }
    SuccessfulGetPhotos:
      description: The requested photos.
      content:
        application/json:
          schema: { $ref: "#/components/schemas/PhotoList" }
      links:
        GetPhotoByPhotoId: { $ref: "#/components/links/GetPhotoByPhotoId"}
    SuccessfulDeletePhoto:
      description: Photo was deleted successfully.
      content:
        application/json:
          schema:
            type: object
            properties:
              photoId: { $ref: "#/components/schemas/photoId" }
    SuccessfulLikePhoto:
      description: A like was added to the photo.
    SuccessfulUnlikePhoto:
      description: The like was removed from the photo.
    SuccessfulGetLikes:
      description: A list of users who liked the photo.
      content:
        application/json:
          schema: { $ref: "#/components/schemas/UserList" }
    SuccessfulGetComments:
      description: A list of comments for the photo.
      content:
        application/json:
          schema: { $ref: "#/components/schemas/CommentList" }
    SuccessfulCommentPhoto:
      description: A comment was successfully added to the photo.
      content:
        application/json:
          schema:
            type: object
            properties:
              commentId: { $ref: "#/components/schemas/commentId" }
    SuccessfulUncommentPhoto:
      description: The comment was successfully removed from the photo.
      content:
        application/json:
          schema:
            type: object
            properties:
              commentId: { $ref: "#/components/schemas/commentId" }
    SuccessfulSearchUser:
      description: A list of users matching the given username.
      content:
        application/json:
          schema: { $ref: "#/components/schemas/UserList" }
    SuccessfulGetUserProfile:
      description: The requested user profile.
      content:
        application/json:
          schema: { $ref: "#/components/schemas/UserProfile" }
      links:
        GetUserPhotosByUserId: { $ref: "#/components/links/GetUserPhotosByUserId" }
    SuccessfulGetFollowing:
      description: The list of following of the user.
      content:
        application/json:
          schema: { $ref: "#/components/schemas/UserList" }
    SuccessfulGetFollowers:
      description: The list of followers of the user.
      content:
        application/json:
          schema: { $ref: "#/components/schemas/UserList" }
    SuccessfulFollowUser:
      description: User was added succesfully to following.
    SuccessfulUnfollowUser:
      description: User was removed successfully from following.
    SuccessfulBanUser:
      description: User was added succesfully to bans.
    SuccessfulUnbanUser:
      description: User was removed succesfully from bans.
    SuccessfulGetMyStream:
      description: The stream of the logged in user.
      content:
        application/json:
          schema: { $ref: "#/components/schemas/PhotoList" }
      links:
        GetPhotoByPhotoId: { $ref: "#/components/links/GetPhotoByPhotoId" }
  parameters:
    QueryStringUsername:
      description: Username passed in query string.
      name: username
      in: query
      schema: { $ref: "#/components/schemas/username" }
      required: true
    QueryStringUserId:
      description: User identifier passed in query string.
      name: userId
      in: query
      schema: { $ref: "#/components/schemas/userId" }
      required: true
    PathUserId:
      description: User identifier passed in path.
      name: userId
      in: path
      schema: { $ref: "#/components/schemas/userId" }
      required: true
    PathPhotoId:
      description: Photo identifier passed in path.
      name: photoId
      in: path
      schema: { $ref: "#/components/schemas/photoId" }
      required: true
    PathCommentId:
      description: Comment identifier passed in path.
      name: commentId
      in: path
      schema: { $ref: "#/components/schemas/commentId" }
      required: true
    Limit:
      description: The maximum number of records to be returned.
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 50
        default: 20
      required: false 
    Offset:
      description: |-
        The number of records to skip. If it is greater than the total number of
        records, the response is an empty array.
      name: offset
      in: query
      schema:
        type: integer
        minimum: 0
        default: 0
  links:
    GetPhotoByPhotoId:
      description: |-
        The `photoId` value in response can be used as `photoId` path parameter in
        `GET /photos/{photoId}`.
      operationId: getPhoto
      parameters:
        photoId: $response.body#/records/photoId
    GetUserPhotosByUserId:
        description: |-
          The `userId` value in response can be used as `userId` query string
          parameter in `GET /photos/`.
        operationId: getPhotos
        parameters:
          userId: $response.body#/records/userId

  securitySchemes:
    bearerAuth:
      description: |-
        Simplified bearer authentication using UUID of the user.
      type: http
      scheme: bearer
      bearerFormat: uuid
